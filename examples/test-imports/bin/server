#!/usr/bin/env node
const connect = require('connect');
const log = require('./log');
const path = require('path');
const portfinder = require('portfinder');
const serveStatic = require('serve-static');
const serveFavicon = require('serve-favicon');

portfinder.basePort = 3000;

module.exports.start = function(middleware) {
  return new Promise((resolve, reject) => {
    const app = connect();

    app.use(serveFavicon('./assets/favicon.ico'));

    app.use(async (req, res, next) => {
      await middleware(req);
      next();
    });

    app.use(serveStatic('.', { index: ['index.html'] }));

    portfinder.getPort(function(err, port) {
      if (err) {
        reject(err);
      }

      app.listen(port, function() {
        resolve(port);
      });
    });
  });
};
